{% extends "base/base.html" %}

{% block title %}Checkout - Solar Store{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="checkout-header">
        <h1>üí≥ Finalizar Compra</h1>
        <p>Revise seus dados e escolha a forma de pagamento</p>
    </div>

    <div class="checkout-content">
        <!-- Resumo do Pedido -->
        <div class="checkout-order-summary">
            <h2>Resumo do Pedido</h2>
            {% for item in items %}
                <div class="order-item">
                    <div>
                        <strong>{{ item.product.name }}</strong><br>
                        <small>Quantidade: {{ item.quantity }}</small>
                    </div>
                    <div style="text-align: right;">
                        R$ {{ item.subtotal|floatformat:2 }}
                    </div>
                </div>
            {% endfor %}
            <div class="order-total">
                Total: R$ {{ total|floatformat:2 }}
            </div>
        </div>

        <!-- Formul√°rio de Pagamento -->
        <div class="checkout-form">
            <h2>Dados de Pagamento</h2>
            <form id="payment-form" method="post" action="">
                {% csrf_token %}

                <div class="form-group">
                    <label for="customer-name">Nome Completo</label>
                    <input 
                        type="text" 
                        id="customer-name" 
                        name="customer_name" 
                        value="{{ request.user.get_full_name|default:request.user.username }}"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="customer-email">Email</label>
                    <input 
                        type="email" 
                        id="customer-email" 
                        name="customer_email" 
                        value="{{ request.user.email }}"
                        required
                    >
                </div>

                <div class="form-group">
                    <label>Forma de Pagamento</label>
                    <div class="payment-methods">
                        <div class="payment-method">
                            <input 
                                type="radio" 
                                id="card-payment" 
                                name="payment_method" 
                                value="card"
                                checked
                            >
                            <label for="card-payment">üí≥ Cart√£o de Cr√©dito</label>
                        </div>
                        <div class="payment-method">
                            <input 
                                type="radio" 
                                id="pix-payment" 
                                name="payment_method" 
                                value="pix"
                                disabled
                                title="Pix dispon√≠vel em breve"
                            >
                            <label for="pix-payment">üì± Pix (Em breve)</label>
                        </div>
                    </div>
                </div>

                <div id="card-element" class="stripe-element" style="display: none;"></div>

                <div id="card-errors" role="alert" style="color: #d9534f; margin-bottom: 1rem; display: none;"></div>

                <button 
                    type="submit" 
                    id="payment-button" 
                    class="payment-button"
                    disabled
                >
                    üí≥ Processar Pagamento - R$ {{ total|floatformat:2 }}
                </button>

                <div class="security-badge">
                    üîí Seus dados de pagamento s√£o processados de forma segura pelo Stripe
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts do Stripe -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#32325d',
                fontFamily: 'Arial, sans-serif'
            },
            invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
            }
        }
    });

    const form = document.getElementById('payment-form');
    const cardMethodRadio = document.getElementById('card-payment');
    const cardElementDiv = document.getElementById('card-element');
    const paymentButton = document.getElementById('payment-button');
    const cardErrors = document.getElementById('card-errors');

    // Mostrar/ocultar card element quando mudar de m√©todo de pagamento
    cardMethodRadio.addEventListener('change', (e) => {
        if (e.target.checked) {
            cardElementDiv.style.display = 'block';
            if (!cardElement.mount.prototype) {
                cardElement.mount('#card-element');
            }
            paymentButton.disabled = false;
        }
    });

    // Montar Stripe Card Element inicialmente
    cardElement.mount('#card-element');
    cardElementDiv.style.display = 'block';
    paymentButton.disabled = false;

    // Escutar mudan√ßas no card element
    cardElement.addEventListener('change', (event) => {
        if (event.error) {
            cardErrors.textContent = event.error.message;
            cardErrors.style.display = 'block';
            paymentButton.disabled = true;
        } else {
            cardErrors.textContent = '';
            cardErrors.style.display = 'none';
            paymentButton.disabled = false;
        }
    });

    // Processar pagamento ao submeter o formul√°rio
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (document.getElementById('card-payment').checked) {
            paymentButton.disabled = true;
            paymentButton.textContent = '‚è≥ Processando...';

            try {
                // Chamar a view para criar a sess√£o do Stripe
                const response = await fetch('{% url "payments:create_session" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({
                        customer_name: document.getElementById('customer-name').value,
                        customer_email: document.getElementById('customer-email').value,
                    })
                });

                const data = await response.json();

                if (data.error) {
                    cardErrors.textContent = data.error;
                    cardErrors.style.display = 'block';
                    paymentButton.disabled = false;
                    paymentButton.textContent = 'üí≥ Processar Pagamento - R$ {{ total|floatformat:2 }}';
                    return;
                }

                if (data.redirectUrl) {
                    // Redirecionar para Stripe Checkout
                    window.location.href = data.redirectUrl;
                }
            } catch (error) {
                cardErrors.textContent = 'Erro ao processar pagamento: ' + error.message;
                cardErrors.style.display = 'block';
                paymentButton.disabled = false;
                paymentButton.textContent = 'üí≥ Processar Pagamento - R$ {{ total|floatformat:2 }}';
            }
        }
    });
</script>
{% endblock %}
